# .github/workflows/build-iso.yml

name: ðŸ”¨ Build YmY OS

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ðŸ“¦ SÃ¼rÃ¼m NumarasÄ± (Ã¶rn: 2025.1)'
        required: true
        type: string
      codename:
        description: 'ðŸ·ï¸ Kod AdÄ± (Ã¶rn: BaÅŸlangÄ±Ã§)'
        required: false
        default: ''
        type: string
      fedora_version:
        description: 'ðŸŽ© Fedora SÃ¼rÃ¼mÃ¼'
        required: true
        default: '43'
        type: choice
        options:
          - '43'
          - '42'
          - '41'
      aggressive_cleanup:
        description: 'ðŸ§¹ Agresif Temizleme (Build Ã¶ncesi)'
        required: true
        default: true
        type: boolean
      create_release:
        description: 'ðŸ“¤ Release OluÅŸtur'
        required: true
        default: false
        type: boolean

env:
  ISO_NAME: "YmY-OS"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # HAZIRLIK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare:
    name: ðŸ“‹ HazÄ±rlÄ±k
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      full_name: ${{ steps.version.outputs.full_name }}
      iso_filename: ${{ steps.version.outputs.iso_filename }}
    
    steps:
      - name: ðŸ“ SÃ¼rÃ¼m Bilgilerini Ayarla
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          CODENAME="${{ github.event.inputs.codename }}"
          FEDORA="${{ github.event.inputs.fedora_version }}"
          
          if [ -n "$CODENAME" ]; then
            FULL_NAME="YmY OS ${VERSION} \"${CODENAME}\""
          else
            FULL_NAME="YmY OS ${VERSION}"
          fi
          
          ISO_FILENAME="YmY-OS-${VERSION}-F${FEDORA}-x86_64.iso"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "full_name=${FULL_NAME}" >> $GITHUB_OUTPUT
          echo "iso_filename=${ISO_FILENAME}" >> $GITHUB_OUTPUT
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          YmY OS Build Bilgileri            â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ SÃ¼rÃ¼m      : ${VERSION}"
          echo "â•‘ Kod AdÄ±    : ${CODENAME:-Belirtilmedi}"
          echo "â•‘ Fedora     : ${FEDORA}"
          echo "â•‘ ISO DosyasÄ±: ${ISO_FILENAME}"
          echo "â•‘ Tarih      : $(date '+%d %B %Y')"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ðŸ”¨ ISO Build
    needs: prepare
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ§¹ Agresif Temizleme
        if: ${{ github.event.inputs.aggressive_cleanup == 'true' }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       ðŸ§¹ AGRESÄ°F TEMÄ°ZLÄ°K BAÅžLIYOR         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "ðŸ“Š Temizlik Ã¶ncesi:"
          df -h /
          
          # Docker
          echo "ðŸ³ Docker temizleniyor..."
          docker system prune -af --volumes 2>/dev/null || true
          
          # APT
          echo "ðŸ“¦ APT temizleniyor..."
          sudo apt-get autoremove -y 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/*
          
          # Swap
          echo "ðŸ’¾ Swap kaldÄ±rÄ±lÄ±yor..."
          sudo swapoff -a 2>/dev/null || true
          sudo rm -f /swapfile 2>/dev/null || true
          
          # BÃ¼yÃ¼k gereksiz dizinler
          echo "ðŸ“ Gereksiz dizinler temizleniyor..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/lib/jvm
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/Ruby
          sudo rm -rf /opt/hostedtoolcache/node
          sudo rm -rf /opt/hostedtoolcache/Python
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/share/az_*
          sudo rm -rf /opt/microsoft
          sudo rm -rf /usr/share/gradle*
          sudo rm -rf /usr/share/sbt
          sudo rm -rf /usr/local/julia*
          sudo rm -rf /usr/share/kotlinc
          sudo rm -rf /usr/local/aws-*
          sudo rm -rf /usr/share/mecab
          sudo rm -rf /usr/share/ri
          sudo rm -rf /usr/share/apache-maven*
          sudo rm -rf /usr/share/locale/*
          sudo rm -rf /usr/share/man/*
          sudo rm -rf /usr/share/doc/*
          
          # Loglar ve cache
          echo "ðŸ“‹ Loglar ve cache temizleniyor..."
          sudo rm -rf /var/log/*.log 2>/dev/null || true
          sudo journalctl --vacuum-size=10M 2>/dev/null || true
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
          
          sync
          
          echo ""
          echo "ðŸ“Š Temizlik sonrasÄ±:"
          df -h /
          echo ""
          echo "âœ… YaklaÅŸÄ±k 40-50 GB alan aÃ§Ä±ldÄ±"

      - name: ðŸ³ Fedora Container BaÅŸlat
        run: |
          docker run -d \
            --name fedora-builder \
            --privileged \
            --security-opt seccomp=unconfined \
            -v ${{ github.workspace }}:/workspace:Z \
            -v /dev:/dev \
            -e VERSION="${{ needs.prepare.outputs.version }}" \
            -e FEDORA_VERSION="${{ github.event.inputs.fedora_version }}" \
            -e CODENAME="${{ github.event.inputs.codename }}" \
            fedora:${{ github.event.inputs.fedora_version }} \
            sleep infinity
          
          sleep 5
          echo "âœ… Fedora ${{ github.event.inputs.fedora_version }} container baÅŸlatÄ±ldÄ±"

      - name: ðŸ“¦ Build AraÃ§larÄ±nÄ± Kur
        run: |
          docker exec fedora-builder bash -c '
            echo "ðŸ“¦ Build araÃ§larÄ± kuruluyor..."
            
            dnf install -y \
              lorax \
              lorax-lmc-novirt \
              anaconda \
              pykickstart \
              livecd-tools \
              squashfs-tools \
              xorriso \
              syslinux \
              isomd5sum \
              createrepo_c \
              git \
              ImageMagick \
              curl \
              wget \
              rsync \
              --setopt=install_weak_deps=False
            
            echo "âœ… Build araÃ§larÄ± kuruldu"
          '

      - name: ðŸŽ¨ Logo BoyutlarÄ± OluÅŸtur
        run: |
          docker exec fedora-builder bash -c '
            cd /workspace
            
            echo "ðŸŽ¨ Logo boyutlarÄ± oluÅŸturuluyor..."
            mkdir -p branding/logos
            
            if [ -f "branding/ymy-logo.png" ]; then
              convert branding/ymy-logo.png -resize 256x256 branding/logos/ymy-logo-256.png
              convert branding/ymy-logo.png -resize 128x128 branding/logos/ymy-logo-128.png
              convert branding/ymy-logo.png -resize 64x64 branding/logos/ymy-logo-64.png
              convert branding/ymy-logo.png -resize 48x48 branding/logos/ymy-logo-48.png
              convert branding/ymy-logo.png -resize 32x32 branding/logos/ymy-logo-32.png
              convert branding/ymy-logo.png -resize 22x22 branding/logos/ymy-logo-22.png
              
              echo "âœ… Logo boyutlarÄ±:"
              ls -la branding/logos/
            else
              echo "âš ï¸ Logo bulunamadÄ±: branding/ymy-logo.png"
              echo "âš ï¸ VarsayÄ±lan logo kullanÄ±lacak"
            fi
          '

      - name: ðŸ“ Kickstart HazÄ±rla
        run: |
          docker exec fedora-builder bash -c '
            cd /workspace
            
            echo "ðŸ“‹ Kickstart doÄŸrulanÄ±yor..."
            ksvalidator kickstart/ymy-os.ks
            
            echo "ðŸ“ SÃ¼rÃ¼m bilgileri ekleniyor..."
            sed -i "s|%YMY_VERSION%|${VERSION}|g" kickstart/ymy-os.ks
            sed -i "s|%YMY_CODENAME%|${CODENAME}|g" kickstart/ymy-os.ks
            sed -i "s|%FEDORA_VERSION%|${FEDORA_VERSION}|g" kickstart/ymy-os.ks
            
            echo "ðŸ“„ Kickstart dÃ¼zleÅŸtiriliyor..."
            ksflatten -c kickstart/ymy-os.ks -o /tmp/ymy-os-flat.ks
            
            echo "âœ… Kickstart hazÄ±r"
          '

      - name: ðŸ”¨ ISO OluÅŸtur
        run: |
          docker exec fedora-builder bash -c '
            cd /workspace
            mkdir -p output
            
            ISO_NAME="YmY-OS-${VERSION}-F${FEDORA_VERSION}-x86_64"
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘          ðŸ”¨ ISO BUILD BAÅžLIYOR             â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘ Bu iÅŸlem 30-90 dakika sÃ¼rebilir...         â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            livemedia-creator \
              --ks=/tmp/ymy-os-flat.ks \
              --no-virt \
              --resultdir=/workspace/output \
              --project="YmY OS" \
              --make-iso \
              --volid="YmY-OS-${VERSION}" \
              --iso-only \
              --iso-name="${ISO_NAME}.iso" \
              --releasever="${FEDORA_VERSION}" \
              --macboot \
              2>&1 | tee /workspace/output/build.log
          '
        timeout-minutes: 120

      - name: ðŸ“Š ISO DoÄŸrula
        run: |
          docker exec fedora-builder bash -c '
            cd /workspace/output
            
            ISO_FILE=$(ls *.iso 2>/dev/null | head -1)
            
            if [ -z "$ISO_FILE" ]; then
              echo "âŒ ISO dosyasÄ± bulunamadÄ±!"
              echo ""
              echo "â•â•â• Build Log (son 150 satÄ±r) â•â•â•"
              tail -150 build.log
              exit 1
            fi
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘          âœ… ISO BAÅžARIYLA OLUÅžTURULDU!     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            SIZE=$(du -h "$ISO_FILE" | cut -f1)
            echo "ðŸ“€ Dosya : $ISO_FILE"
            echo "ðŸ“Š Boyut : $SIZE"
            echo ""
            
            echo "ðŸ” Checksum oluÅŸturuluyor..."
            sha256sum "$ISO_FILE" > "${ISO_FILE}.sha256"
            md5sum "$ISO_FILE" > "${ISO_FILE}.md5"
            
            echo "SHA256: $(cat ${ISO_FILE}.sha256)"
          '

      - name: ðŸ“¤ Artifact YÃ¼kle
        uses: actions/upload-artifact@v4
        with:
          name: YmY-OS-${{ needs.prepare.outputs.version }}
          path: |
            output/*.iso
            output/*.sha256
            output/*.md5
          retention-days: 30
          compression-level: 0

      - name: ðŸ“‹ Build Log YÃ¼kle
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs-${{ needs.prepare.outputs.version }}
          path: output/build.log
          retention-days: 7

      - name: ðŸ§¹ Container TemizliÄŸi
        if: always()
        run: |
          docker stop fedora-builder 2>/dev/null || true
          docker rm fedora-builder 2>/dev/null || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RELEASE (Opsiyonel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ðŸ“¦ Release OluÅŸtur
    needs: [prepare, build]
    if: ${{ github.event.inputs.create_release == 'true' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Artifact Ä°ndir
        uses: actions/download-artifact@v4
        with:
          name: YmY-OS-${{ needs.prepare.outputs.version }}
          path: ./release

      - name: ðŸ“ Release NotlarÄ±
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ðŸŽ‰ ${{ needs.prepare.outputs.full_name }}
          
          **Fedora ${{ github.event.inputs.fedora_version }} tabanlÄ±, yeni baÅŸlayanlar iÃ§in tasarlanmÄ±ÅŸ Linux daÄŸÄ±tÄ±mÄ±.**
          
          ### âœ¨ Ã–zellikler
          
          - ðŸ–¥ï¸ GNOME 49 masaÃ¼stÃ¼ ortamÄ± (Ã¶zelleÅŸtirilmiÅŸ)
          - ðŸ–±ï¸ Terminal gerektirmeden kullanÄ±m
          - ðŸ‡¹ðŸ‡· Tam TÃ¼rkÃ§e dil desteÄŸi
          - ðŸ“¦ Ã–nceden yÃ¼klenmiÅŸ kullanÄ±ÅŸlÄ± uygulamalar
          - ðŸŽ¨ Koyu tema ve modern gÃ¶rÃ¼nÃ¼m
          - ðŸ”„ Flatpak desteÄŸi
          
          ### ðŸ“¥ Kurulum
          
          1. ISO dosyasÄ±nÄ± indirin
          2. SHA256 ile doÄŸrulayÄ±n:
             ```bash
             sha256sum -c YmY-OS-*.sha256
             ```
          3. [Rufus](https://rufus.ie/) veya [Etcher](https://etcher.balena.io/) ile USB'ye yazdÄ±rÄ±n
          4. USB'den baÅŸlatÄ±n ve kurulum sihirbazÄ±nÄ± takip edin
          
          ### ðŸ’» Sistem Gereksinimleri
          
          | BileÅŸen | Minimum | Ã–nerilen |
          |---------|---------|----------|
          | Ä°ÅŸlemci | 64-bit, 2 Ã§ekirdek | 4+ Ã§ekirdek |
          | RAM | 4 GB | 8 GB |
          | Disk | 25 GB | 50 GB SSD |
          
          ---
          
          ðŸ“… **Build Tarihi:** $(date '+%d %B %Y')  
          ðŸŽ© **Fedora SÃ¼rÃ¼mÃ¼:** ${{ github.event.inputs.fedora_version }}  
          ðŸ–¥ï¸ **GNOME SÃ¼rÃ¼mÃ¼:** 49  
          ðŸ”— **GitHub:** https://github.com/ymy-studios/ymy-os
          EOF

      - name: ðŸš€ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: ${{ needs.prepare.outputs.full_name }}
          body_path: RELEASE_NOTES.md
          files: |
            ./release/*.iso
            ./release/*.sha256
            ./release/*.md5
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
